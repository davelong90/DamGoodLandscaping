---
import { getCollection, render } from 'astro:content';
import ProjectLayout from '../../layouts/ProjectLayout.astro';
import BeforeAfterSlider from '../../components/portfolio/BeforeAfterSlider.astro';
import ServiceTag from '../../components/shared/ServiceTag.astro';
import CTABlock from '../../components/shared/CTABlock.astro';
import { site } from '../../data/site';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map(project => ({
    params: { slug: project.id },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);
const { title, location, date, services, beforeImages, afterImages, thumbnail, excerpt } = project.data;

const formattedDate = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Build slider pairs: pair each before with matching after (use first after if no match)
const sliderPairs = beforeImages.map((before, i) => ({
  before,
  after: afterImages[i] ?? afterImages[0],
}));
---

<ProjectLayout
  title={title}
  excerpt={excerpt}
  thumbnail={thumbnail}
>
  <!-- Project header -->
  <header class="project-header section-dark section">
    <div class="container">
      <nav aria-label="Breadcrumb" class="breadcrumb">
        <a href="/portfolio">Portfolio</a>
        <span aria-hidden="true">/</span>
        <span aria-current="page">{title}</span>
      </nav>
      <h1>{title}</h1>
      <div class="project-meta">
        <span class="meta-item">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
            <circle cx="12" cy="10" r="3"/>
          </svg>
          {location}
        </span>
        <span class="meta-item">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          <time datetime={date.toISOString()}>{formattedDate}</time>
        </span>
      </div>
      <div class="tag-group mt-4">
        {services.map(s => <ServiceTag service={s} />)}
      </div>
    </div>
  </header>

  <!-- Before/After sliders -->
  <section class="section" aria-labelledby="gallery-heading">
    <div class="container">
      <h2 id="gallery-heading" class="slider-section-title">Before &amp; After</h2>
      <p class="slider-hint">Drag the slider to reveal the transformation.</p>

      <div class="sliders-grid">
        {sliderPairs.map((pair, i) => (
          <BeforeAfterSlider
            beforeSrc={pair.before}
            afterSrc={pair.after}
            beforeAlt={`Before — ${title} (image ${i + 1})`}
            afterAlt={`After — ${title} (image ${i + 1})`}
          />
        ))}
      </div>
    </div>
  </section>

  <!-- Project narrative -->
  <section class="section section-alt" aria-labelledby="narrative-heading">
    <div class="container-narrow">
      <h2 id="narrative-heading" class="visually-hidden">Project Details</h2>
      <div class="prose project-prose">
        <Content />
      </div>

      <div class="services-used">
        <h3>Services Performed</h3>
        <div class="tag-group">
          {services.map(s => <ServiceTag service={s} />)}
        </div>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="section">
    <div class="container">
      <CTABlock
        title="Want Results Like This?"
        description={`Get a free estimate for your yard. We serve ${site.serviceArea} — fast response guaranteed.`}
        primaryText="Request a Free Quote"
        primaryHref="/contact"
        secondaryText="See All Projects"
        secondaryHref="/portfolio"
        variant="green"
      />
    </div>
  </section>
</ProjectLayout>

<style>
  /* Header */
  .project-header {
    padding-bottom: var(--space-16);
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--font-sm);
    margin-bottom: var(--space-5);
    color: rgba(255,255,255,0.6);
  }

  .breadcrumb a {
    color: var(--color-green-300);
    text-decoration: none;
  }

  .breadcrumb a:hover {
    text-decoration: underline;
    color: var(--color-white);
  }

  .project-header h1 {
    color: var(--color-white);
    margin-bottom: var(--space-4);
    font-size: clamp(var(--font-2xl), 4vw, var(--font-4xl));
  }

  .project-meta {
    display: flex;
    gap: var(--space-5);
    flex-wrap: wrap;
    color: rgba(255,255,255,0.75);
    font-size: var(--font-sm);
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  /* Sliders */
  .slider-section-title {
    text-align: center;
    margin-bottom: var(--space-2);
  }

  .slider-hint {
    text-align: center;
    color: var(--color-text-muted);
    font-size: var(--font-sm);
    margin-bottom: var(--space-8);
  }

  .sliders-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-8);
    max-width: 900px;
    margin: 0 auto;
  }

  @media (min-width: 768px) {
    .sliders-grid {
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    }
  }

  /* Prose */
  .project-prose {
    margin-bottom: var(--space-10);
  }

  .project-prose h2 {
    color: var(--color-primary);
    border-left: 4px solid var(--color-green-500);
    padding-left: var(--space-4);
    margin-top: var(--space-10);
  }

  .services-used {
    padding-top: var(--space-8);
    border-top: 1px solid var(--color-border);
  }

  .services-used h3 {
    font-size: var(--font-base);
    font-weight: var(--weight-semibold);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: var(--space-4);
  }
</style>
