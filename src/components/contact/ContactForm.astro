---
import { services } from '../../data/services';
---

<div class="contact-form-wrapper">
  <form
    id="contact-form"
    name="contact"
    method="POST"
    data-netlify="true"
    netlify-honeypot="bot-field"
    novalidate
  >
    <!-- Netlify hidden field -->
    <input type="hidden" name="form-name" value="contact" />

    <!-- Honeypot -->
    <div class="visually-hidden" aria-hidden="true">
      <label>
        Don't fill this out if you're human:
        <input name="bot-field" tabindex="-1" autocomplete="off" />
      </label>
    </div>

    <div class="form-row">
      <!-- Name -->
      <div class="form-group">
        <label class="form-label" for="name">
          Name <span class="required" aria-hidden="true">*</span>
        </label>
        <input
          id="name"
          name="name"
          type="text"
          class="form-input"
          placeholder="Jane Smith"
          required
          autocomplete="name"
        />
      </div>

      <!-- Phone -->
      <div class="form-group">
        <label class="form-label" for="phone">
          Phone <span class="required" aria-hidden="true">*</span>
        </label>
        <input
          id="phone"
          name="phone"
          type="tel"
          class="form-input"
          placeholder="(555) 000-0000"
          required
          autocomplete="tel"
        />
      </div>
    </div>

    <div class="form-row">
      <!-- Email -->
      <div class="form-group">
        <label class="form-label" for="email">
          Email <span class="form-optional">(optional)</span>
        </label>
        <input
          id="email"
          name="email"
          type="email"
          class="form-input"
          placeholder="jane@example.com"
          autocomplete="email"
        />
      </div>

      <!-- ZIP -->
      <div class="form-group">
        <label class="form-label" for="zip">
          ZIP Code <span class="required" aria-hidden="true">*</span>
        </label>
        <input
          id="zip"
          name="zip"
          type="text"
          class="form-input"
          placeholder="75001"
          required
          autocomplete="postal-code"
          maxlength="10"
        />
      </div>
    </div>

    <!-- Services needed -->
    <div class="form-group">
      <fieldset>
        <legend class="form-label">
          Services Needed <span class="required" aria-hidden="true">*</span>
        </legend>
        <div class="form-radio-group" id="services-group">
          {services.map(s => (
            <label class="form-radio-label">
              <input type="checkbox" name="services" value={s.slug} />
              {s.name}
            </label>
          ))}
          <label class="form-radio-label">
            <input type="checkbox" name="services" value="other" />
            Other / Not Sure
          </label>
        </div>
        <p class="services-error" id="services-error" hidden>Please select at least one service.</p>
      </fieldset>
    </div>

    <!-- Description -->
    <div class="form-group">
      <label class="form-label" for="description">
        Project Description <span class="required" aria-hidden="true">*</span>
      </label>
      <textarea
        id="description"
        name="description"
        class="form-textarea"
        placeholder="Describe your yard, what you need done, any special considerations..."
        required
        rows="5"
      ></textarea>
    </div>

    <!-- Preferred contact method -->
    <div class="form-group">
      <fieldset>
        <legend class="form-label">Preferred Contact Method</legend>
        <div class="form-radio-group">
          <label class="form-radio-label">
            <input type="radio" name="contact_method" value="phone" checked />
            Phone call
          </label>
          <label class="form-radio-label">
            <input type="radio" name="contact_method" value="text" />
            Text message
          </label>
          <label class="form-radio-label">
            <input type="radio" name="contact_method" value="email" />
            Email
          </label>
        </div>
      </fieldset>
    </div>

    <!-- Photo upload -->
    <div class="form-group">
      <label class="form-label" for="photos">
        Photos <span class="form-optional">(optional — helps us give a better estimate)</span>
      </label>
      <input
        id="photos"
        name="photos"
        type="file"
        class="form-input file-input"
        accept="image/*"
        multiple
      />
    </div>

    <!-- Submit -->
    <button type="submit" class="btn btn-primary btn-lg submit-btn">
      Send My Quote Request
    </button>
  </form>

  <!-- Success message (hidden until form submitted) -->
  <div id="form-success" class="form-success" hidden role="alert">
    <div class="form-success-icon" aria-hidden="true">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
    </div>
    <h3>Request Sent!</h3>
    <p>
      Thanks for reaching out. We will get back to you within one business day —
      usually much faster. Keep an eye on your phone.
    </p>
  </div>
</div>

<style>
  .contact-form-wrapper {
    max-width: 640px;
    margin: 0 auto;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-5);
  }

  @media (min-width: 540px) {
    .form-row {
      grid-template-columns: 1fr 1fr;
    }
  }

  form {
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }

  fieldset {
    border: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  legend.form-label {
    display: block;
  }

  .form-radio-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .form-radio-label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    cursor: pointer;
    font-size: var(--font-base);
  }

  .services-error {
    font-size: var(--font-sm);
    color: var(--color-danger, #c0392b);
    margin-top: var(--space-1);
  }

  .form-optional {
    font-weight: var(--weight-normal);
    font-size: var(--font-xs);
    color: var(--color-text-muted);
  }

  .file-input {
    padding: var(--space-2) var(--space-3);
    cursor: pointer;
  }

  .submit-btn {
    width: 100%;
  }

  /* Success state */
  .form-success {
    text-align: center;
    padding: var(--space-12) var(--space-6);
  }

  .form-success-icon {
    color: var(--color-primary);
    margin-bottom: var(--space-6);
  }

  .form-success h3 {
    font-size: var(--font-2xl);
    margin-bottom: var(--space-4);
    color: var(--color-primary);
  }

  .form-success p {
    color: var(--color-text-muted);
    font-size: var(--font-lg);
    line-height: var(--leading-relaxed);
  }
</style>

<script>
  const form    = document.getElementById('contact-form') as HTMLFormElement | null;
  const success = document.getElementById('form-success');

  const servicesError = document.getElementById('services-error');
  const servicesGroup = document.getElementById('services-group');

  servicesGroup?.addEventListener('change', () => {
    const anyChecked = form?.querySelectorAll<HTMLInputElement>('input[name="services"]:checked').length ?? 0;
    if (servicesError) servicesError.hidden = anyChecked > 0;
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const checkedServices = form.querySelectorAll<HTMLInputElement>('input[name="services"]:checked');
    if (checkedServices.length === 0) {
      if (servicesError) servicesError.hidden = false;
      servicesGroup?.querySelector('input')?.focus();
      return;
    }
    if (servicesError) servicesError.hidden = true;

    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    const submitBtn = form.querySelector<HTMLButtonElement>('[type="submit"]');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
    }

    try {
      // On Netlify, this POST is intercepted and processed server-side.
      // In local dev it will fail gracefully — we still show success below.
      await fetch('/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(new FormData(form) as unknown as Record<string, string>).toString(),
      });
    } catch {
      // Expected in local dev — continue to show success state
    } finally {
      form.hidden = true;
      if (success) {
        success.hidden = false;
        success.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
  });
</script>
